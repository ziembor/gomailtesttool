# Change Log: Version 2.3.3

**Release Date:** 2026-01-25

This release fixes a critical TLS version selection issue where the `-tlsversion` flag was not enforcing the exact TLS version specified by the user.

## Key Highlights

✅ **Fixed TLS version selection** - Now forces exact TLS version instead of treating it as minimum
✅ **Enhanced debug logging** - Shows configured TLS version in debug output
✅ **Improved user experience** - Flag behavior now matches user expectations
✅ **Better testing capabilities** - Allows testing specific TLS versions for compatibility verification
⚠️ **Breaking change** - `-tlsversion` behavior changed (see Breaking Changes section)

---

## Bug Fixes

### 1. Fixed TLS Version Selection to Force Exact Version

**Issue**: The `-tlsversion` flag was being treated as a **minimum** TLS version rather than the exact version to use. When users specified `-tlsversion 1.2`, the tool would negotiate TLS 1.3 if the server supported it.

**Problem**: The TLS configuration only set `MinVersion`, leaving `MaxVersion` unset (defaulting to 0). According to Go's `crypto/tls` documentation, when `MaxVersion` is 0, the TLS library negotiates the highest mutually supported version.

Example of unexpected behavior:
```bash
# User specified TLS 1.2
smtptool.exe -action teststarttls -host example.com -port 587 -tlsversion 1.2

# But tool negotiated TLS 1.3 instead!
Protocol Version:    TLS 1.3  # ❌ Expected TLS 1.2
```

**Root Cause Analysis**:
```go
// OLD CODE - Only set MinVersion
tlsConfig := &tls.Config{
    ServerName:         config.Host,
    InsecureSkipVerify: config.SkipVerify,
    MinVersion:         smtptls.ParseTLSVersion(config.TLSVersion),
    // MaxVersion not set - defaults to 0 (use latest version)
}
```

Per Go documentation:
- `MinVersion` = minimum TLS version to accept
- `MaxVersion` = 0 means "use the highest version supported by both client and server"
- Result: Tool negotiated highest mutually supported version (TLS 1.3) instead of exact version (TLS 1.2)

**Solution**: Changed `-tlsversion` flag behavior to set **both** `MinVersion` and `MaxVersion` to the same value, forcing the exact TLS version specified:

```go
// NEW CODE - Force exact version
tlsVersion := smtptls.ParseTLSVersion(config.TLSVersion)
tlsConfig := &tls.Config{
    ServerName:         config.Host,
    InsecureSkipVerify: config.SkipVerify,
    MinVersion:         tlsVersion,
    MaxVersion:         tlsVersion, // Force exact TLS version
}
```

**Benefits**:
- ✅ User expectations met - `-tlsversion 1.2` now uses exactly TLS 1.2
- ✅ Better testing capabilities - Can test specific TLS version compatibility
- ✅ Predictable behavior - No more unexpected version negotiation
- ✅ Security testing - Can verify servers properly support specific TLS versions
- ✅ Compliance testing - Can verify TLS version requirements

**Example Fixed Behavior**:
```bash
# Test with TLS 1.2 - now uses exactly TLS 1.2
smtptool.exe -action teststarttls -host example.com -port 587 -tlsversion 1.2
Protocol Version:    TLS 1.2  # ✅ Correct!

# Test with TLS 1.3 - now uses exactly TLS 1.3
smtptool.exe -action teststarttls -host example.com -port 587 -tlsversion 1.3
Protocol Version:    TLS 1.3  # ✅ Correct!
```

**Verification in Debug Logs**:
```
level=DEBUG msg="Starting TLS handshake" skipVerify=false tlsVersion=1.2 minVersion=771 maxVersion=771
```
Note: 771 is the decimal representation of TLS 1.2 constant (0x0303)

### 2. Enhanced Debug Logging for TLS Configuration

**Enhancement**: Added detailed debug logging in `teststarttls` action to show the configured TLS version settings before handshake.

**New Debug Output**:
```go
logger.LogDebug(slogLogger, "Starting TLS handshake",
    "skipVerify", config.SkipVerify,
    "tlsVersion", config.TLSVersion,    // User-specified version string
    "minVersion", tlsVersion,            // Numeric TLS version constant
    "maxVersion", tlsVersion)            // Numeric TLS version constant
```

**Benefits**:
- ✅ Transparency - Users can verify exact TLS version being configured
- ✅ Debugging - Easier to diagnose TLS version issues
- ✅ Validation - Confirms tool is using specified version before handshake

**Example Debug Output**:
```
time=2026-01-25T07:36:59.542+01:00 level=DEBUG msg="Starting TLS handshake"
    skipVerify=false
    tlsVersion=1.2
    minVersion=771
    maxVersion=771
```

### 3. Updated Configuration Documentation

**Changes**: Updated flag and struct documentation to reflect new behavior.

**Flag Description Updated** (`config.go:123`):
```go
// BEFORE:
tlsVersion := flag.String("tlsversion", "1.2", "Minimum TLS version: 1.2, 1.3 (env: SMTPTLSVERSION)")

// AFTER:
tlsVersion := flag.String("tlsversion", "1.2", "TLS version to use (exact): 1.2, 1.3 (env: SMTPTLSVERSION)")
```

**Struct Comment Updated** (`config.go:39`):
```go
// BEFORE:
TLSVersion string // Minimum TLS version (1.2, 1.3)

// AFTER:
TLSVersion string // TLS version to use (exact match): 1.2, 1.3
```

**Benefits**:
- ✅ Clear documentation - Users understand flag behavior
- ✅ No confusion - Explicit "exact" language in help text
- ✅ Consistency - Code comments match actual behavior

---

## Breaking Changes

⚠️ **TLS Version Flag Behavior Change**

**What Changed**: The `-tlsversion` flag now forces the **exact** TLS version specified instead of treating it as a **minimum** version.

**Impact**:
- **Before v2.3.3**: `-tlsversion 1.2` meant "TLS 1.2 or higher" (would negotiate TLS 1.3 if available)
- **After v2.3.3**: `-tlsversion 1.2` means "exactly TLS 1.2" (will not negotiate TLS 1.3)

**Who is Affected**:
- Users who relied on the old "minimum version" behavior
- Scripts/automation expecting version negotiation to highest supported

**Why This Change**:
- Matches user expectations - when you specify a version, you expect that version
- Essential for testing - need to test specific TLS versions for compatibility
- Better for security auditing - can verify exact TLS version support
- Industry standard - most TLS testing tools force exact versions

**Migration**:
- ✅ **No action needed** if you want exact version testing (recommended for SMTP testing)
- ⚠️ If you need "minimum version" behavior, this will be added in a future release as a separate flag
- ⚠️ For now, if you need TLS 1.2 or higher, use `-tlsversion 1.3` to get highest version

**User Acceptance**: The project maintainer (sole current user) has accepted this breaking change as it fixes unexpected behavior and improves testing capabilities.

---

## Files Modified

### Core TLS Configuration
- `cmd/smtptool/teststarttls.go` (lines 73-80)
  - Changed to set both MinVersion and MaxVersion to same value
  - Added enhanced debug logging with TLS version details

- `cmd/smtptool/sendmail.go` (lines 63-70)
  - Changed to set both MinVersion and MaxVersion to same value

- `cmd/smtptool/testauth.go` (lines 72-79)
  - Changed to set both MinVersion and MaxVersion to same value

### Configuration & Documentation
- `cmd/smtptool/config.go` (line 39)
  - Updated TLSVersion struct field comment to "exact match"

- `cmd/smtptool/config.go` (line 123)
  - Updated flag description from "Minimum" to "exact"

### Documentation
- `ChangeLog/2.3.3.md` - THIS FILE

---

## Technical Details

### TLS Version Constants

Go's `crypto/tls` package uses the following constants:
- **TLS 1.0**: `0x0301` (decimal: 769)
- **TLS 1.1**: `0x0302` (decimal: 770)
- **TLS 1.2**: `0x0303` (decimal: 771)
- **TLS 1.3**: `0x0304` (decimal: 772)

These are visible in debug logs as `minVersion` and `maxVersion` values.

### TLS Version Negotiation Behavior

**Before v2.3.3** (MinVersion only set):
```
Client: "I support TLS 1.2 to TLS 1.3"
Server: "I support TLS 1.2 to TLS 1.3"
Negotiated: TLS 1.3 (highest mutually supported)
```

**After v2.3.3** (Both MinVersion and MaxVersion set):
```
Client: "I only support TLS 1.2"
Server: "I support TLS 1.2 to TLS 1.3"
Negotiated: TLS 1.2 (exact version requested)
```

### Implementation Pattern

The fix follows this pattern in all three actions:

1. Parse version string to TLS constant once:
   ```go
   tlsVersion := smtptls.ParseTLSVersion(config.TLSVersion)
   ```

2. Set both Min and Max to same value:
   ```go
   tlsConfig := &tls.Config{
       MinVersion: tlsVersion,
       MaxVersion: tlsVersion,
   }
   ```

3. Log configured version for verification:
   ```go
   logger.LogDebug(..., "tlsVersion", config.TLSVersion,
       "minVersion", tlsVersion, "maxVersion", tlsVersion)
   ```

### Security Implications

**Positive**:
- ✅ More control over TLS version for security testing
- ✅ Can verify servers properly reject outdated TLS versions
- ✅ Can test TLS 1.2 vs 1.3 behavior differences
- ✅ Better compliance verification capabilities

**Considerations**:
- ⚠️ Users must explicitly choose TLS 1.3 if they want it (no auto-upgrade)
- ⚠️ Default remains TLS 1.2 for backward compatibility
- ⚠️ Consider updating default to TLS 1.3 in future major version

---

## Testing

### Automated Testing
- ✅ Build successful on Windows
- ✅ All existing unit tests pass
- ✅ Version verification successful

### Manual Verification Testing

**Test 1: TLS 1.2 Exact Version**
```bash
smtptool.exe -action teststarttls -host zbtcm625q.szw.zblabaz.eu -port 587 -tlsversion 1.2
```
**Result**: ✅ Protocol Version: TLS 1.2 (exactly as specified)
**Debug Log**: `tlsVersion=1.2 minVersion=771 maxVersion=771`

**Test 2: TLS 1.3 Exact Version**
```bash
smtptool.exe -action teststarttls -host zbtcm625q.szw.zblabaz.eu -port 587 -tlsversion 1.3
```
**Result**: ✅ Protocol Version: TLS 1.3 (exactly as specified)
**Debug Log**: `tlsVersion=1.3 minVersion=772 maxVersion=772`

**Test 3: sendmail Action Compatibility**
```bash
smtptool.exe -action sendmail -host <host> -port 587 -tlsversion 1.2 -from test@example.com -to test@example.com -verbose
```
**Result**: ✅ Uses TLS 1.2 for STARTTLS upgrade

**Test 4: testauth Action Compatibility**
```bash
smtptool.exe -action testauth -host <host> -port 587 -tlsversion 1.2 -username user -password pass
```
**Result**: ✅ Uses TLS 1.2 for STARTTLS upgrade

### Regression Testing
- ✅ All existing functionality unchanged (except TLS version selection)
- ✅ STARTTLS still works on all supported ports (25, 587, 2525, 2526, 1025)
- ✅ Authentication still works after STARTTLS
- ✅ Certificate verification follows `-skipverify` flag
- ✅ Debug logging works correctly

---

## Upgrade Notes

### For Existing Users

**If you currently use `-tlsversion 1.2`:**
- **v2.3.2 behavior**: Connected with TLS 1.3 if server supported it
- **v2.3.3 behavior**: Connects with exactly TLS 1.2
- **Action needed**: None if you want exact version testing (recommended)
- **Action needed**: Change to `-tlsversion 1.3` if you want TLS 1.3

**If you currently use `-tlsversion 1.3`:**
- **No change**: Already connects with TLS 1.3
- **Action needed**: None

**If you don't specify `-tlsversion`:**
- **Behavior**: Default is still TLS 1.2
- **v2.3.2**: Would negotiate TLS 1.3 if available
- **v2.3.3**: Will use exactly TLS 1.2
- **Action needed**: Add `-tlsversion 1.3` to use TLS 1.3

### Recommended Default

Consider using `-tlsversion 1.3` as your default going forward:
```bash
export SMTPTLSVERSION=1.3
```

TLS 1.3 provides:
- Better security
- Faster handshakes
- Improved cipher suites
- Forward secrecy

### Future Enhancements

If "minimum version" behavior is needed, a future release may add:
- `-tlsversion-min` flag for minimum version behavior
- `-tlsversion-max` flag for maximum version cap
- Keep `-tlsversion` as exact version (current behavior)

---

## Use Cases

### Testing TLS 1.2 Compatibility
```bash
# Verify server supports TLS 1.2
smtptool.exe -action teststarttls -host smtp.example.com -port 587 -tlsversion 1.2

# If successful, server supports TLS 1.2
# If fails with handshake error, server doesn't support TLS 1.2
```

### Testing TLS 1.3 Support
```bash
# Verify server supports TLS 1.3
smtptool.exe -action teststarttls -host smtp.example.com -port 587 -tlsversion 1.3

# If successful, server supports TLS 1.3
# If fails, server doesn't support TLS 1.3 yet
```

### Security Compliance Verification
```bash
# Verify server rejects TLS 1.0/1.1 (deprecated)
smtptool.exe -action teststarttls -host smtp.example.com -port 587 -tlsversion 1.0
# Expected: Should fail (handshake error) if server is properly configured

# Verify server accepts TLS 1.2 minimum
smtptool.exe -action teststarttls -host smtp.example.com -port 587 -tlsversion 1.2
# Expected: Should succeed for compliant servers
```

### Cipher Suite Testing
```bash
# Different TLS versions support different cipher suites
# Test what ciphers are negotiated with each version

# TLS 1.2 ciphers
smtptool.exe -action teststarttls -host smtp.example.com -port 587 -tlsversion 1.2 -verbose
# Shows: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (common TLS 1.2 cipher)

# TLS 1.3 ciphers
smtptool.exe -action teststarttls -host smtp.example.com -port 587 -tlsversion 1.3 -verbose
# Shows: TLS_AES_128_GCM_SHA256 (TLS 1.3 cipher)
```

---

## Security Considerations

### Positive Security Impact
- ✅ Better testing capabilities for TLS version requirements
- ✅ Can verify servers properly enforce minimum TLS versions
- ✅ Can test compliance with security policies (e.g., "TLS 1.2+ only")
- ✅ More predictable behavior for security-conscious users

### Important Notes
- ⚠️ Default is still TLS 1.2 for backward compatibility
- ⚠️ Users should explicitly choose TLS 1.3 for maximum security
- ⚠️ Tool will not auto-upgrade to TLS 1.3 anymore
- ⚠️ Consider updating default to TLS 1.3 in a future major version (v3.0.0)

### Recommendations
1. Use `-tlsversion 1.3` for production mail sending (maximum security)
2. Use `-tlsversion 1.2` only for compatibility testing
3. Never use TLS 1.0 or 1.1 (deprecated and insecure)
4. Set environment variable for consistent behavior:
   ```bash
   export SMTPTLSVERSION=1.3
   ```

---

## Contributors

- Claude Sonnet 4.5 (AI Assistant)
- Project Maintainer: ziembor

---

## Links

- **Repository**: https://github.com/ziembor/msgraphgolangtestingtool
- **Release Tag**: v2.3.3
- **Previous Release**: v2.3.2 (2026-01-17)
- **SMTP Tool Documentation**: SMTP_TOOL_README.md
- **Build Instructions**: BUILD.md

---

## Summary

Version 2.3.3 fixes a critical TLS version selection issue that caused unexpected behavior when users specified a TLS version. The tool now forces the exact TLS version specified, matching user expectations and enabling better testing capabilities. While this is a breaking change, it fixes unexpected behavior and improves the tool's usefulness for SMTP testing and security verification.

**Key takeaway**: `-tlsversion 1.2` now means "use exactly TLS 1.2", not "TLS 1.2 or higher".
