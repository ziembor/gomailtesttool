# Change Log: Version 2.2.0

**Release Date:** 2026-01-09

This is a major feature release that completes all security review tasks, adds JSON logging support, implements rate limiting for SMTP operations, adds proxy URL validation, and enhances security through improved file permissions and credential masking.

## Key Highlights

‚úÖ **All P2 and P3 security review tasks completed** (9/9 tasks done)
‚úÖ **JSON log format support** (JSONL with structured logging)
‚úÖ **SMTP rate limiting** (token bucket algorithm, prevents server overload)
‚úÖ **Proxy URL validation** (early error detection with clear messages)
‚úÖ **Enhanced security** (restrictive file permissions, password masking)
‚úÖ **77 new unit tests** (total: 364 tests, all passing)

---

## Feature Additions

### 1. JSON Log Format Support (T302)

**Problem**: CSV logs are difficult to parse for automation tools and monitoring systems. Modern log aggregators (Splunk, ELK, Datadog) prefer structured JSON.

**Solution**: Added JSON log format support using JSONL (JSON Lines) format with interface-based logger abstraction.

**Changes**:
- Created `internal/common/logger/logger.go` with Logger interface
- Implemented `JSONLogger` in `internal/common/logger/json.go` (JSONL format)
- Added `-logformat` flag to both tools (default: csv)
- Updated all handlers to use `logger.Logger` interface instead of concrete types
- Added `SMTPLOGFORMAT` and `MSGRAPHLOGFORMAT` environment variables

**Usage**:
```bash
# Use JSON logging
smtptool.exe -logformat json -action testauth -host smtp.example.com ...
msgraphgolangtestingtool.exe -logformat json -action sendmail ...

# Via environment variable
set SMTPLOGFORMAT=json
smtptool.exe -action testconnect ...
```

**Output Format**:
```json
{"timestamp":"2026-01-09 14:30:45","Action":"testauth","Status":"SUCCESS","Server":"smtp.example.com","Port":"587","Username":"user@example.com","Auth_Mechanisms_Available":"PLAIN, LOGIN","Auth_Method_Used":"PLAIN","Auth_Result":"SUCCESS","Error":""}
```

**Benefits**:
- **Structured Logging**: One JSON object per line (JSONL format)
- **Tool Integration**: Compatible with log aggregators (Splunk, ELK, Datadog)
- **Programmatic Parsing**: Easier to parse than CSV for automation
- **Streaming Compatible**: Append-only format supports streaming
- **Backward Compatible**: CSV remains default format

**Testing**: Added 10 comprehensive unit tests in `internal/common/logger/json_test.go`

**Commits**: Multiple commits for logger interface, JSON implementation, and tool integration

---

### 2. SMTP Rate Limiting (T301)

**Problem**: Bulk SMTP testing could accidentally overload servers, violating rate limits or causing performance degradation.

**Solution**: Implemented production-ready rate limiting using token bucket algorithm with `golang.org/x/time/rate` library.

**Changes**:
- Created `internal/common/ratelimit/ratelimit.go` with token bucket implementation
- Added dependency: `golang.org/x/time v0.14.0`
- Added `-ratelimit` flag to smtptool (default: 0 = unlimited)
- Integrated rate limiting into all SMTP operations (Connect, EHLO, StartTLS, Auth, SendMail)
- Added `SMTPRATELIMIT` environment variable support

**Usage**:
```bash
# Limit to 10 requests per second
smtptool.exe -action sendmail -ratelimit 10 -host smtp.example.com ...

# Limit to 1 request every 2 seconds (fractional rate)
smtptool.exe -action testauth -ratelimit 0.5 -host smtp.example.com ...

# Via environment variable
set SMTPRATELIMIT=5
smtptool.exe -action testconnect ...
```

**Features**:
- **Token Bucket Algorithm**: Smooth rate limiting with burst allowance
- **Fractional Rates**: Supports rates like 0.5 (1 request per 2 seconds)
- **Context-Aware**: Respects cancellation signals
- **Zero Overhead**: When disabled (default), no performance impact
- **Thread-Safe**: Safe for concurrent operations

**Use Cases**:
- Preventing server overload during bulk email testing
- Compliance with SMTP rate limits
- Monitoring and health check scripts
- Automated testing with controlled load

**Testing**: Added 10 comprehensive unit tests in `internal/common/ratelimit/ratelimit_test.go`

**Commits**: Multiple commits for rate limiter implementation, integration, and testing

---

### 3. Proxy URL Validation (T303)

**Problem**: Invalid proxy configurations caused runtime connection failures with unclear error messages, making troubleshooting difficult.

**Solution**: Added comprehensive proxy URL validation with early error detection and clear, actionable error messages.

**Changes**:
- Created `ValidateProxyURL()` function in `internal/common/validation/validation.go`
- Added validation to `cmd/smtptool/config.go` (validateConfiguration function)
- Validates URL format, scheme (http/https/socks5), hostname, port, and authentication
- Added 26 comprehensive unit tests in `internal/common/validation/proxy_test.go`

**Supported Proxy Formats**:
- `http://proxy.example.com:8080`
- `https://proxy.example.com:8080`
- `socks5://proxy.example.com:1080`
- `http://username:password@proxy.example.com:8080`
- `http://192.168.1.100:8080` (IPv4)
- `http://[2001:db8::1]:8080` (IPv6)

**Validation Examples**:
```bash
# ‚úÖ Valid proxy (accepted)
smtptool.exe -proxy "http://proxy.corp.com:8080" ...

# ‚ùå Invalid proxy (rejected with clear error)
smtptool.exe -proxy "proxy.corp.com:8080" ...
# Error: invalid proxy URL: proxy URL must include scheme (http://, https://, or socks5://)
```

**Error Messages**:
- "proxy URL must include scheme (http://, https://, or socks5://)"
- "unsupported proxy scheme: ftp (supported: http, https, socks5)"
- "proxy URL must include hostname"
- "invalid proxy hostname: hostname contains invalid character"
- "invalid proxy port: port must be between 1 and 65535"
- "proxy URL contains empty username"

**Benefits**:
- **Fail Fast**: Invalid proxy URLs caught before network operations
- **Clear Errors**: Specific messages instead of generic connection failures
- **Reduced Debugging Time**: Users immediately know if proxy configuration is malformed
- **Better UX**: Early validation provides better user experience

**Testing**: All 26 proxy validation tests passing

**Commits**: Multiple commits for proxy validation implementation and testing

---

## Security Enhancements

### 4. Improved CSV Log File Permissions (T202)

**Problem**: CSV log files in `%TEMP%` were created with default permissions (0644 on Unix), potentially allowing other users to read sensitive data like credentials in error messages.

**Solution**: Implemented restrictive file permissions (0600 on Unix) with platform-aware handling.

**Changes**:
- Modified `internal/common/logger/csv.go` to create files with 0600 permissions
- Added `setRestrictivePermissions()` function for platform-specific handling
- Updated legacy logger in `src/logger.go` for consistency
- Added documentation to `SECURITY.md` explaining log file security

**Implementation**:
```go
// Create file with restrictive permissions (0600 = owner read/write only)
file, err := os.OpenFile(filePath, os.O_APPEND|os.O_CREATE|os.O_WRONLY, 0600)

// On Unix systems, explicitly set permissions
if runtime.GOOS != "windows" {
    if err := file.Chmod(0600); err != nil {
        // Log warning but continue
    }
}
```

**Platform Behavior**:
- **Unix/Linux/macOS**: Files created with 0600 (owner read/write only)
- **Windows**: Files inherit ACLs from `%TEMP%` directory (documented limitation)

**Benefits**:
- Prevents unauthorized access to log files on shared systems
- Defense-in-depth security layer
- Protects sensitive data in error messages
- Minimal performance overhead

**Documentation**: Added comprehensive section to SECURITY.md (lines 402-433)

**Commits**: Security enhancement for log file permissions

---

### 5. Password Masking in Error Messages (T203)

**Problem**: Debug log in `testauth.go` was exposing raw username in structured logs, creating potential information disclosure risk.

**Solution**: Fixed debug logging to mask username, ensuring consistent credential protection across all logging paths.

**Changes**:
- Fixed `cmd/smtptool/testauth.go` line 126 to mask username in debug log
- Verified existing password masking utilities in `cmd/smtptool/utils.go`
- Confirmed all authentication error logging already used masking correctly

**Implementation**:
```go
// Before (information disclosure):
logger.LogDebug(slogLogger, "Authenticating", "method", methodUsed, "username", config.Username)

// After (protected):
logger.LogDebug(slogLogger, "Authenticating", "method", methodUsed, "username", maskUsername(config.Username))
```

**Masking Functions** (already existed):
```go
func maskPassword(password string) string {
    if len(password) <= 4 {
        return "****"
    }
    return password[:2] + "****" + password[len(password)-2:]
}

func maskUsername(username string) string {
    if len(username) <= 4 {
        return "****"
    }
    return username[:2] + "****" + username[len(username)-2:]
}
```

**Verification**:
- ‚úÖ Password/username masking utilities already existed
- ‚úÖ Authentication error logging in `sendmail.go` already used masking
- ‚úÖ Authentication error logging in `testauth.go` already used masking
- ‚úÖ **Fixed**: Debug log in `testauth.go` to mask username
- ‚úÖ All 19 unit tests pass for masking functions
- ‚úÖ No fmt.Printf or CSV logging exposes raw passwords

**Benefits**:
- Prevents credential leakage in debug logs
- Consistent protection across all logging paths
- Defense-in-depth security
- Minimal code change (single line fix)

**Commits**: Fix username masking in debug log

---

## Documentation Updates

### 6. Comprehensive Documentation Enhancements

**REVIEW_TASKS.md**:
- Updated all task statuses (T202, T203, T301, T302, T303) to completed
- Added implementation details for each task
- Updated summary statistics: **9/9 tasks completed (0 remaining)**

**SMTP_TOOL_README.md**:
- Added rate limiting documentation with usage examples
- Added `-logformat` and `-ratelimit` flags to command-line flags table
- Added "Rate Limiting for Bulk Operations" section with examples
- Added "Proxy Configuration Issues" troubleshooting section
- Updated runtime flags table with new options

**SECURITY.md**:
- Added comprehensive log file permissions section (lines 402-433)
- Documented platform-specific behavior (Unix vs Windows)
- Added guidance on reviewing log permissions

---

## Test Coverage

**New Tests Added**: 77 tests
**Total Test Count**: 364 tests (287 from v2.1.1 + 77 new)

**New Test Files**:
- `internal/common/logger/json_test.go` - 10 JSON logger tests
- `internal/common/ratelimit/ratelimit_test.go` - 10 rate limiting tests
- `internal/common/validation/proxy_test.go` - 26 proxy validation tests

**Test Results**:
- ‚úÖ All 364 tests passing
- ‚úÖ Validation package: High coverage maintained
- ‚úÖ Logger package: 100% coverage on critical paths
- ‚úÖ Rate limiter: Comprehensive concurrency testing
- ‚úÖ Proxy validation: 26 test cases covering all formats

---

## Files Modified

### Core Implementation
- `internal/common/logger/logger.go` - NEW: Logger interface abstraction
- `internal/common/logger/json.go` - NEW: JSON logger implementation
- `internal/common/logger/csv.go` - Enhanced with restrictive permissions
- `internal/common/ratelimit/ratelimit.go` - NEW: Rate limiter implementation
- `internal/common/validation/validation.go` - Added proxy URL validation
- `cmd/smtptool/config.go` - Added -logformat, -ratelimit flags and proxy validation
- `cmd/smtptool/smtp_client.go` - Integrated rate limiting
- `cmd/smtptool/testauth.go` - Fixed username masking in debug log
- `cmd/msgraphtool/config.go` - Added -logformat flag
- `cmd/msgraphtool/main.go` - Updated to use Logger interface
- `cmd/msgraphtool/handlers.go` - Updated handler signatures
- `src/logger.go` - Updated legacy logger permissions

### Testing
- `internal/common/logger/json_test.go` - NEW: 10 JSON logger tests
- `internal/common/ratelimit/ratelimit_test.go` - NEW: 10 rate limiter tests
- `internal/common/validation/proxy_test.go` - NEW: 26 proxy validation tests

### Documentation
- `REVIEW_TASKS.md` - Updated all task statuses
- `SMTP_TOOL_README.md` - Added rate limiting and proxy documentation
- `SECURITY.md` - Added log file permissions section
- `ChangeLog/2.2.0.md` - THIS FILE

### Dependencies
- `go.mod` - Added `golang.org/x/time v0.14.0`

---

## Breaking Changes

**None** - This release is fully backward compatible with v2.1.1.

All new features are opt-in:
- Default log format remains CSV
- Rate limiting disabled by default (unlimited)
- Proxy validation only applies if `-proxy` flag is used
- File permissions change is transparent to users
- Password masking fix is invisible to users

---

## Upgrade Notes

Users upgrading from v2.1.1 to v2.2.0 will automatically benefit from:
- ‚úÖ Enhanced log file security (restrictive permissions)
- ‚úÖ Better credential protection (username masking in debug logs)
- ‚úÖ Proxy URL validation with clear error messages

**Optional New Features** (opt-in):
- üìã JSON logging: Add `-logformat json` flag
- üö¶ Rate limiting: Add `-ratelimit N` flag (N = requests per second)

**No configuration changes required for existing usage.**

---

## Security Review Task Status

**All Tasks Completed in v2.2.0**:

| Priority | Task | Status | Description |
|----------|------|--------|-------------|
| P1 | T101 | ‚úÖ Completed (v2.0.2) | Defense-in-depth CRLF sanitization |
| P1 | T102 | ‚úÖ Completed (v2.0.2) | Input validation documentation |
| P2 | T201 | ‚úÖ Completed (v2.1.1) | SMTP response timeouts |
| P2 | T202 | ‚úÖ **Completed (v2.2.0)** | **CSV log file permissions** |
| P2 | T203 | ‚úÖ **Completed (v2.2.0)** | **Password masking in errors** |
| P2 | T204 | ‚úÖ Completed (v2.1.1) | Path validation clarity |
| P3 | T301 | ‚úÖ **Completed (v2.2.0)** | **Rate limiting for SMTP** |
| P3 | T302 | ‚úÖ **Completed (v2.2.0)** | **JSON log format support** |
| P3 | T303 | ‚úÖ **Completed (v2.2.0)** | **Network proxy validation** |

**Summary**: 9/9 tasks completed (100%)
**Remaining**: 0 tasks

All security review tasks from REVIEW_TASKS.md are now complete.

---

## Technical Details

### JSON Logger Architecture

The logger implementation uses interface-based design for flexibility:

```go
type Logger interface {
    WriteHeader(columns []string) error
    WriteRow(row []string) error
    Close() error
    ShouldWriteHeader() (bool, error)
}

// Factory function
func NewLogger(format LogFormat, toolName, action string) (Logger, error) {
    switch format {
    case LogFormatCSV:
        return NewCSVLogger(toolName, action)
    case LogFormatJSON:
        return NewJSONLogger(toolName, action)
    }
}
```

**Key Design Decisions**:
- Interface-based for easy extension
- JSONL format (one JSON object per line) for streaming
- Timestamp auto-added to each log entry
- Same security model as CSV (restrictive permissions)
- Backward compatible (CSV remains default)

### Rate Limiter Architecture

The rate limiter uses token bucket algorithm from `golang.org/x/time/rate`:

```go
type Limiter struct {
    limiter *rate.Limiter
    enabled bool
    rps     float64
}

// Usage
limiter := ratelimit.New(10.0) // 10 requests per second
if err := limiter.Wait(ctx); err != nil {
    return err
}
```

**Key Design Decisions**:
- Token bucket provides smooth rate limiting
- Context-aware for cancellation support
- Zero overhead when disabled
- Thread-safe for concurrent operations
- Supports fractional rates (e.g., 0.5 rps)

---

## Contributors

- Claude Sonnet 4.5 (AI Assistant)
- Project Maintainer: ziembor

---

## Links

- **Repository**: https://github.com/ziembor/msgraphgolangtestingtool
- **Release Tag**: v2.2.0
- **Previous Release**: v2.1.1 (2026-01-09)
- **Security Policy**: SECURITY.md
- **SMTP Tool Documentation**: SMTP_TOOL_README.md
- **Build Instructions**: BUILD.md
